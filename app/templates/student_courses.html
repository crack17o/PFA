{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto py-8">
  <h1 class="text-3xl font-bold mb-6">Mes cours</h1>
  <div class="mb-6">
    <button id="add-course-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">S'inscrire à un cours</button>
  </div>
  <table class="min-w-full bg-white rounded-lg shadow">
    <thead>
      <tr>
        <th class="py-2 px-4">Nom</th>
        <th class="py-2 px-4">Crédits</th>
        <th class="py-2 px-4">Action</th>
      </tr>
    </thead>
    <tbody id="courses-list"></tbody>
  </table>
</div>
<!-- Modal d'inscription -->
<div id="course-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">S'inscrire à un cours</h2>
    <select id="available-courses" class="w-full border rounded px-3 py-2 mb-4"></select>
    <div class="flex justify-end gap-2">
      <button id="close-modal" class="bg-gray-400 text-white px-4 py-2 rounded">Annuler</button>
      <button id="enroll-btn" class="bg-blue-600 text-white px-4 py-2 rounded">S'inscrire</button>
    </div>
    <div id="modal-msg" class="mt-4 text-center text-sm"></div>
  </div>
</div>
<!-- Modal séances -->
<div id="sessions-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
    <h2 class="text-xl font-bold mb-4">Séances du cours</h2>
    <div id="sessions-list-modal" class="mb-4"></div>
    <div class="flex justify-end">
      <button id="close-sessions-modal" class="bg-gray-400 text-white px-4 py-2 rounded">Fermer</button>
    </div>
  </div>
</div>
<script>
function loadCourses() {
  fetch('/api/student/courses')
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('courses-list');
      tbody.innerHTML = '';
      (data.courses || []).forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class='py-2 px-4'>${c.name}</td><td class='py-2 px-4'>${c.credits}</td><td class='py-2 px-4'><button onclick="showSessions('${c.id}')" class='bg-blue-500 text-white px-2 py-1 rounded mr-2'>Voir</button><button onclick="unenrollCourse('${c.id}')" class='bg-red-500 text-white px-2 py-1 rounded'>Désinscrire</button></td>`;
        tbody.appendChild(tr);
      });
    });
}
function unenrollCourse(courseId) {
  fetch(`/api/student/courses/${courseId}`, {method: 'DELETE'})
    .then(res => res.json())
    .then(() => loadCourses());
}
function showSessions(courseId) {
  fetch('/api/student/courses')
    .then(res => res.json())
    .then(data => {
      const course = (data.courses || []).find(c => c.id === courseId);
      const modal = document.getElementById('sessions-modal');
      const list = document.getElementById('sessions-list-modal');
      if (!course || !course.sessions || !course.sessions.length) {
        list.innerHTML = '<div class="text-gray-500">Aucune séance prévue pour ce cours.</div>';
      } else {
        let html = '<ul class="list-disc pl-4">';
        course.sessions.forEach(s => {
          html += `<li>${s.date} - <span class='font-semibold'>${s.status}</span></li>`;
        });
        html += '</ul>';
        list.innerHTML = html;
      }
      modal.classList.remove('hidden');
    });
}
function showCourseModal() {
  document.getElementById('course-modal').classList.remove('hidden');
  fetch('/api/student/promotion/courses')
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById('available-courses');
      select.innerHTML = '';
      (data.courses || []).forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.name} (${c.credits} crédits)`;
        select.appendChild(option);
      });
    });
}
document.getElementById('add-course-btn').onclick = showCourseModal;
document.getElementById('close-modal').onclick = function() {
  document.getElementById('course-modal').classList.add('hidden');
};
document.getElementById('enroll-btn').onclick = function() {
  const courseId = document.getElementById('available-courses').value;
  fetch('/api/student/courses', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({course_id: courseId})
  }).then(res => res.json()).then(data => {
    document.getElementById('modal-msg').textContent = data.message || 'Inscription effectuée.';
    setTimeout(() => {
      document.getElementById('course-modal').classList.add('hidden');
      loadCourses();
    }, 1000);
  });
};
document.getElementById('close-sessions-modal').onclick = function() {
  document.getElementById('sessions-modal').classList.add('hidden');
};
loadCourses();
</script>
{% endblock %}
